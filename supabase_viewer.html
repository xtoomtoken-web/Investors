<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Data Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-700 text-white">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-white mb-8 text-center">📊 Supabase Data Viewer</h1>
        
        <!-- Status -->
        <div id="status" class="mb-6 p-4 rounded-xl border border-gray-600 bg-gray-800">
            <div class="flex items-center space-x-2">
                <div id="statusIcon">🔄</div>
                <span id="statusText">Connecting to Supabase...</span>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-4 mb-6">
            <button onclick="loadAllData()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-xl font-semibold transition-colors">
                📋 Load All Users
            </button>
            <button onclick="getStats()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-xl font-semibold transition-colors">
                📈 Get Statistics
            </button>
            <button onclick="testConnection()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-xl font-semibold transition-colors">
                🔍 Test Connection
            </button>
        </div>

        <!-- Search -->
        <div class="mb-6">
            <div class="flex gap-4">
                <input 
                    type="text" 
                    id="walletSearch" 
                    placeholder="Search by wallet address..." 
                    class="flex-1 bg-gray-800 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400"
                >
                <button onclick="searchByWallet()" class="bg-cyan-600 hover:bg-cyan-700 px-6 py-3 rounded-xl font-semibold transition-colors">
                    🔍 Search
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="bg-gray-800 rounded-xl p-6 border border-gray-600">
            <h2 class="text-xl font-semibold mb-4">Results will appear here...</h2>
            <div id="resultContent" class="text-gray-300">
                Click "Load All Users" to start viewing data
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration (same as dashboard)
        const SUPABASE_URL = 'https://slowkvbzjopnsgiwfdvs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb3drdmJ6am9wbnNnaXdmZHZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTk5ODQsImV4cCI6MjA3NDM5NTk4NH0.phvZ282_EGIbrAv54bigNPH9eIw4qZmC1Fa0y9Q-_d4';
        
        let supabase;

        // Initialize Supabase
        function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                updateStatus('✅', 'Connected to Supabase', 'success');
                console.log('✅ Supabase initialized successfully');
                return true;
            } catch (error) {
                updateStatus('❌', `Error: ${error.message}`, 'error');
                console.error('❌ Supabase initialization error:', error);
                return false;
            }
        }

        // Update status display
        function updateStatus(icon, text, type = 'info') {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusText').textContent = text;
            
            const statusDiv = document.getElementById('status');
            statusDiv.className = `mb-6 p-4 rounded-xl border ${
                type === 'success' ? 'border-green-500 bg-green-900/20' :
                type === 'error' ? 'border-red-500 bg-red-900/20' :
                'border-gray-600 bg-gray-800'
            }`;
        }

        // Test connection
        async function testConnection() {
            updateStatus('🔄', 'Testing connection...', 'info');
            
            try {
                const { data, error, count } = await supabase
                    .from('investors')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                updateStatus('✅', `Connection successful! Found ${count} records`, 'success');
                updateResults(`<div class="text-green-400 font-semibold">
                    🎉 Connection Test Successful!<br>
                    📊 Database contains ${count} investor records<br>
                    🕒 Last tested: ${new Date().toLocaleString()}
                </div>`);
            } catch (error) {
                updateStatus('❌', `Connection failed: ${error.message}`, 'error');
                updateResults(`<div class="text-red-400 font-semibold">❌ Error: ${error.message}</div>`);
            }
        }

        // Load all data
        async function loadAllData() {
            updateStatus('🔄', 'Loading all user data...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('investors')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                updateStatus('✅', `Loaded ${data.length} records successfully`, 'success');
                displayUsersTable(data);
                
            } catch (error) {
                updateStatus('❌', `Loading failed: ${error.message}`, 'error');
                updateResults(`<div class="text-red-400 font-semibold">❌ Error: ${error.message}</div>`);
            }
        }

        // Search by wallet
        async function searchByWallet() {
            const wallet = document.getElementById('walletSearch').value.trim();
            if (!wallet) {
                alert('Please enter a wallet address');
                return;
            }

            updateStatus('🔍', 'Searching...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('investors')
                    .select('*')
                    .ilike('wallet_address', `%${wallet}%`);
                
                if (error) {
                    throw error;
                }
                
                updateStatus('✅', `Found ${data.length} matching records`, 'success');
                displayUsersTable(data);
                
            } catch (error) {
                updateStatus('❌', `Search failed: ${error.message}`, 'error');
                updateResults(`<div class="text-red-400 font-semibold">❌ Error: ${error.message}</div>`);
            }
        }

        // Get statistics
        async function getStats() {
            updateStatus('🔄', 'Calculating statistics...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('investors')
                    .select('initial_investment, initial_date, created_at');
                
                if (error) {
                    throw error;
                }
                
                const totalUsers = data.length;
                const totalInvestment = data.reduce((sum, user) => sum + parseFloat(user.initial_investment || 0), 0);
                const avgInvestment = totalUsers > 0 ? totalInvestment / totalUsers : 0;
                
                // Date stats
                const dates = data.map(u => new Date(u.created_at));
                const oldestUser = dates.length > 0 ? new Date(Math.min(...dates)) : null;
                const newestUser = dates.length > 0 ? new Date(Math.max(...dates)) : null;

                updateStatus('✅', 'Statistics calculated successfully', 'success');
                
                const statsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                            <div class="text-blue-400 font-semibold">👥 Total Users</div>
                            <div class="text-2xl font-bold text-white">${totalUsers}</div>
                        </div>
                        <div class="bg-green-900/20 border border-green-500/30 rounded-xl p-4">
                            <div class="text-green-400 font-semibold">💰 Total Investment</div>
                            <div class="text-2xl font-bold text-white">$${totalInvestment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4">
                            <div class="text-purple-400 font-semibold">📊 Average Investment</div>
                            <div class="text-2xl font-bold text-white">$${avgInvestment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-400">
                        📅 First user registered: ${oldestUser ? oldestUser.toLocaleDateString() : 'N/A'}<br>
                        🆕 Latest user registered: ${newestUser ? newestUser.toLocaleDateString() : 'N/A'}
                    </div>
                `;
                
                updateResults(statsHtml);
                
            } catch (error) {
                updateStatus('❌', `Statistics failed: ${error.message}`, 'error');
                updateResults(`<div class="text-red-400 font-semibold">❌ Error: ${error.message}</div>`);
            }
        }

        // Display users in table format
        function displayUsersTable(users) {
            if (users.length === 0) {
                updateResults(`<div class="text-gray-400 text-center py-8">📭 No users found</div>`);
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-3 px-4 text-gray-300">👤 Name</th>
                                <th class="text-left py-3 px-4 text-gray-300">💼 Wallet</th>
                                <th class="text-left py-3 px-4 text-gray-300">💰 Investment</th>
                                <th class="text-left py-3 px-4 text-gray-300">📅 Date</th>
                                <th class="text-left py-3 px-4 text-gray-300">🕒 Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr class="border-b border-gray-700 hover:bg-gray-700/30 transition-colors">
                                    <td class="py-3 px-4 font-medium text-white">${user.name || 'N/A'}</td>
                                    <td class="py-3 px-4">
                                        <code class="text-xs text-cyan-400 bg-gray-800 px-2 py-1 rounded">
                                            ${user.wallet_address ? `${user.wallet_address.slice(0, 6)}...${user.wallet_address.slice(-4)}` : 'N/A'}
                                        </code>
                                    </td>
                                    <td class="py-3 px-4 text-green-400 font-semibold">
                                        $${parseFloat(user.initial_investment || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                    </td>
                                    <td class="py-3 px-4 text-gray-300">
                                        ${user.initial_date ? new Date(user.initial_date).toLocaleDateString() : 'N/A'}
                                    </td>
                                    <td class="py-3 px-4 text-gray-400 text-sm">
                                        ${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-400">
                    📊 Total: ${users.length} user${users.length !== 1 ? 's' : ''}
                </div>
            `;
            
            updateResults(tableHtml);
        }

        // Update results display
        function updateResults(html) {
            document.getElementById('resultContent').innerHTML = html;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Supabase Viewer initialized');
            initSupabase();
        });
    </script>
</body>
</html>